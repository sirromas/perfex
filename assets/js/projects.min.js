function fix_phases_height(){if(!is_mobile()){var e=Math.max.apply(null,$("div.tasks-phases .panel-body").map(function(){return $(this).outerHeight()}).get());$("div.tasks-phases .panel-body").css("min-height",e+"px")}}function milestones_switch_view(){$("#milestones-table").toggleClass("hide"),$(".tasks-phases").toggleClass("hide"),$("#milestones-table").hasClass("hide")?$(".new-task-phase").removeClass("hide"):$(".new-task-phase").addClass("hide"),fix_phases_height()}function manage_discussion(e){var t=$(e).serialize(),i=e.action;return $.post(i,t).done(function(e){1==(e=JSON.parse(e)).success&&alert_float("success",e.message),$(".table-project-discussions").DataTable().ajax.reload(null,!1),$("#discussion").modal("hide")}),!1}function manage_timesheets(e){var t=$(e).serialize(),i=e.action;$.post(i,t).done(function(e){1==(e=JSON.parse(e)).success?alert_float("success",e.message):alert_float("warning",e.message),setTimeout(function(){window.location.reload()},1e3)})}function edit_timesheet(e,t){$('#timesheet select[name="timesheet_staff_id"]').attr("data-staff_id",$(e).attr("data-timesheet_staff_id")),$('select[name="timesheet_task_id"]').selectpicker("val",$(e).attr("data-timesheet_task_id")),$('input[name="timer_id"]').val(t),$('input[name="start_time"]').val($(e).attr("data-start_time")),$('input[name="end_time"]').val($(e).attr("data-end_time")),$('#timesheet textarea[name="note"]').val($(e).attr("data-note")),$('select[name="timesheet_task_id"]').change(),$("#timesheet").modal("show"),setTimeout(function(){var t=$(e).attr("data-tags").split(",");for(var i in t)$("#timesheet #tags").tagit("createTag",t[i])},500)}function new_discussion(){$("#discussion").modal("show"),$("#discussion .edit-title").addClass("hide")}function new_milestone(){$("#milestone").modal("show"),$("#milestone .edit-title").addClass("hide")}function new_timesheet(){$("#timesheet").modal("show")}function edit_milestone(e,t){1==$(e).data("description-visible-to-customer")?$('input[name="description_visible_to_customer"]').prop("checked",!0):$('input[name="description_visible_to_customer"]').prop("checked",!1),$("#additional_milestone").append(hidden_input("id",t)),$('#milestone input[name="name"]').val($(e).data("name")),$('#milestone input[name="due_date"]').val($(e).data("due_date")),$('#milestone input[name="milestone_order"]').val($(e).data("order")),$('#milestone textarea[name="description"]').val($(e).data("description")),$("#milestone").modal("show"),$("#milestone .add-title").addClass("hide")}function edit_discussion(e,t){$("#additional_discussion").append(hidden_input("id",t)),$('#discussion input[name="subject"]').val($(e).data("subject")),$('#discussion textarea[name="description"]').val($(e).data("description"));var i=!0;0==$(e).data("show-to-customer")&&(i=!1),$('#discussion input[name="show_to_customer"]').prop("checked",i),$("#discussion").modal("show"),$("#discussion .add-title").addClass("hide")}function mass_stop_timers(e){$.get(admin_url+"projects/mass_stop_timers/"+project_id+"/"+e,function(e){alert_float(e.type,e.message),setTimeout(function(){$("body").find(".modal-backdrop").eq(0).remove(),init_timers(),reload_tasks_tables(),pre_invoice_project()},500)},"json")}function pre_invoice_project(){$.get(admin_url+"projects/get_pre_invoice_project_info/"+project_id,function(e){$("#pre_invoice_project").html(e),$("#pre_invoice_project_settings").modal("show")})}function invoice_project(e){$("#pre_invoice_project_settings").modal("hide");var t={};t.type=$('input[name="invoice_data_type"]:checked').val(),t.timesheets_include_notes=$('input[name="timesheets_include_notes"]:checked').val(),t.project_id=e,t.tasks=$("#tasks_who_will_be_billed input:checkbox:checked").map(function(){return $(this).val()}).get(),t.expenses=$("#expenses_who_will_be_billed input:checkbox:checked").map(function(){return $(this).val()}).get(),$.post(admin_url+"projects/get_invoice_project_data/",t).done(function(e){$("#invoice_project").html(e),$("#invoice-project-modal").modal({show:!0,backdrop:"static"})})}function delete_project_discussion(e){if(0==confirm(appLang.confirm_action_prompt))return!1;$.get(admin_url+"projects/delete_discussion/"+e,function(e){alert_float(e.alert_type,e.message),$(".table-project-discussions").DataTable().ajax.reload(null,!1)},"json")}function copy_project(){$("#copy_project").modal("show")}function projectExpenseSubmitHandler(e){return $.post(e.action,$(e).serialize()).done(function(e){(e=JSON.parse(e)).expenseid&&void 0!==expenseDropzone&&expenseDropzone.getQueuedFiles().length>0?(expenseDropzone.options.url=admin_url+"expenses/add_expense_attachment/"+e.expenseid,expenseDropzone.processQueue()):window.location.assign(e.url)}),!1}function view_project_file(e,t){$("#project_file_data").empty(),$("#project_file_data").load(admin_url+"projects/file/"+e+"/"+project_id,function(e,t,i){"error"==t&&alert_float("danger",i.statusText)})}function update_file_data(e){var t={};t.id=e,t.subject=$('body input[name="file_subject"]').val(),t.description=$('body textarea[name="file_description"]').val(),$.post(admin_url+"projects/update_file_data/",t)}function project_mark_as_modal(e,t){$("#mark_tasks_finished_modal").modal("show"),$("#project_mark_status_confirm").attr("data-status-id",e),$("#project_mark_status_confirm").attr("data-project-id",project_id);var i=$("#project_marked_as_finished_email_to_contacts");4==e?i.length>0&&i.parents(".project_marked_as_finished").removeClass("hide"):i.length>0&&(i.prop("checked",!1),i.parents(".project_marked_as_finished").addClass("hide"))}function project_files_bulk_action(e){if(0==confirm(appLang.confirm_action_prompt))return!1;var t=$("#mass_delete").prop("checked"),i=[],a={};0==t||void 0===t?a.visible_to_customer=$("#bulk_pf_visible_to_customer").prop("checked"):a.mass_delete=!0;var s=$(".table-project-files").find("tbody tr");$.each(s,function(){var e=$($(this).find("td").eq(0)).find("input");1==e.prop("checked")&&i.push(e.val())}),a.ids=i,$(e).addClass("disabled"),setTimeout(function(){$.post(admin_url+"projects/bulk_action_files",a).done(function(){window.location.reload()})},200)}function gantt_filter(){var e=$('select[name="gantt_task_status"]').selectpicker("val"),t=$('select[name="gantt_type"]').selectpicker("val"),i=[];i.gantt_type=t,i.group="project_gantt",e&&(i.gantt_task_status=e),window.location.href=buildUrl(admin_url+"projects/view/"+project_id,i)}function confirm_project_status_change(e){var t={};if($(e).attr("disabled",!0),t.project_id=$(e).data("project-id"),t.status_id=$(e).data("status-id"),4==t.status_id){var i=$("#project_marked_as_finished_email_to_contacts");i.length>0&&(t.send_project_marked_as_finished_email_to_contacts=!0===i.prop("checked")?1:0)}t.mark_all_tasks_as_completed=!0===$("#mark_all_tasks_as_completed").prop("checked")?1:0,t.notify_project_members_status_change=!0===$("#notify_project_members_status_change").prop("checked")?1:0,$.post(admin_url+"projects/mark_as",t).done(function(e){e=JSON.parse(e),alert_float(!0===e.success?"success":"warning",e.message),setTimeout(function(){window.location.reload()},1500)}).fail(function(e){window.location.reload()})}$(window).on("load",function(){fix_phases_height()}),$(window).resize(function(){fix_phases_height()}),Dropzone.options.projectFilesUpload=!1,Dropzone.options.projectExpenseForm=!1;var expenseDropzone;$(function(){$("ul.project-actions li:first-child").next("li.divider").remove(),init_invoice();var e=get_url_param("file_id");e&&view_project_file(e,project_id);var t=$("#project_file_data,#discussion-comments");if(t.on("focus",'[contenteditable="true"]',function(){$.Shortcuts.stop()}),t.on("focusout",'[contenteditable="true"]',function(){$.Shortcuts.start()}),$("body").on("show.bs.modal","._project_file",function(){discussion_comments("#project-file-discussion",discussion_id,"file")}),$("body").on("shown.bs.modal","#milestone",function(){$("#milestone").find('input[name="name"]').focus()}),$("#timesheetsChart").length>0&&"undefined"!=typeof project_overview_chart){var i={type:"bar",data:{},options:{responsive:!0,maintainAspectRatio:!1,tooltips:{enabled:!0,mode:"single",callbacks:{label:function(e,t){return decimalToHM(e.yLabel)}}},scales:{yAxes:[{ticks:{beginAtZero:!0,min:0,userCallback:function(e,t,i){return decimalToHM(e)}}}]}}};i.data=project_overview_chart.data;var a=document.getElementById("timesheetsChart");timesheetsChart=new Chart(a,i)}$("#project_top").on("change",function(){var e=$(this).val(),t=get_url_param("group");t=t?"?group="+t:"",window.location.href=admin_url+"projects/view/"+e+t}),"undefined"!=typeof Dropbox&&$("#dropbox-chooser").length>0&&document.getElementById("dropbox-chooser").appendChild(Dropbox.createChooseButton({success:function(e){$.post(admin_url+"projects/add_external_file",{files:e,project_id:project_id,external:"dropbox",visible_to_customer:$("#pf_visible_to_customer").prop("checked")}).done(function(){var e=window.location.href;window.location.href=e.split("?")[0]+"?group=project_files"})},linkType:"preview",extensions:app_allowed_files.split(",")}));for(var s=-10;s<$(".task-phase").not(".color-not-auto-adjusted").length/2;s++){$(".task-phase:eq("+(s+10)+")").not(".color-not-auto-adjusted").css("background",color(120-13*s,169-13*s,56-13*s)).css("border","1px solid "+color(120-13*s,169-13*s,56-13*s))}fix_phases_height(),$("body").on("click",".milestone-column .cpicker,.milestone-column .reset_milestone_color",function(e){e.preventDefault();var t=$(this).data("color"),i=$(this),a=i.parents(".milestone-column").data("milestone-id");$.post(admin_url+"projects/change_milestone_color",{color:t,milestone_id:a}).done(function(){""==t?window.location.reload():(i.parents(".milestone-column").find(".reset_milestone_color").removeClass("hide"),i.parents(".milestone-column").find(".panel-heading").addClass("color-white").removeClass("task-phase"),i.parents(".milestone-column").find(".edit-milestone-phase").addClass("color-white"))})}),$("body").find(".milestone-tasks-wrapper").sortable({connectWith:".ms-task",helper:"clone",items:"li.sortable",placeholder:"ui-sortable-placeholder",start:function(e,t){$(t.helper).addClass("tilt"),$(t.helper).find(".panel-body").css("background","#fbfbfb"),tilt_direction($(t.helper))},stop:function(e,t){$(t.helper).removeClass("tilt"),$("html").unbind("mousemove",$(t.helper).data("move_handler")),$(t.helper).removeData("move_handler")},update:function(e,t){if(this===t.item.parent()[0]){data={},data.order=[],data.milestone_id=$(t.item.parent()[0]).parents(".milestone-column").data("milestone-id"),data.task_id=$(t.item).data("task-id");var i=$(t.item.parent()[0]).parents(".milestone-column").find(".task"),a=0;$.each(i,function(){data.order.push([$(this).data("task-id"),a]),a++}),fix_phases_height(),setTimeout(function(){$.post(admin_url+"projects/update_task_milestone",data)},50)}}}),$("#project-files-upload").length>0&&(projectFilesUpload=new Dropzone("#project-files-upload",{paramName:"file",addRemoveLinks:!0,dictFileTooBig:appLang.file_exceeds_maxfile_size_in_form,dictDefaultMessage:appLang.drop_files_here_to_upload,dictFallbackMessage:appLang.browser_not_support_drag_and_drop,dictRemoveFile:appLang.remove_file,dictCancelUpload:appLang.cancel_upload,acceptedFiles:app_allowed_files,maxFilesize:(max_php_ini_upload_size_bytes/1048576).toFixed(0),accept:function(e,t){t()},success:function(e,t){0===this.getUploadingFiles().length&&0===this.getQueuedFiles().length&&window.location.reload()},error:function(e,t){alert_float("danger",t)},sending:function(e,t,i){i.append("visible_to_customer",$('input[name="visible_to_customer"]').prop("checked"))}})),$("#project-expense-form").length>0&&(expenseDropzone=new Dropzone("#project-expense-form",{autoProcessQueue:!1,clickable:"#dropzoneDragArea",acceptedFiles:app_allowed_files,previewsContainer:".dropzone-previews",dictFileTooBig:appLang.file_exceeds_maxfile_size_in_form,dictDefaultMessage:appLang.drop_files_here_to_upload,dictFallbackMessage:appLang.browser_not_support_drag_and_drop,dictRemoveFile:appLang.remove_file,dictMaxFilesExceeded:appLang.you_can_not_upload_any_more_files,addRemoveLinks:!0,maxFiles:1,error:function(e,t){alert_float("danger",t)},success:function(e,t){0===this.getUploadingFiles().length&&0===this.getQueuedFiles().length&&window.location.reload()}})),_validate_form($("#project-expense-form"),{category:"required",date:"required",amount:"required",currency:"required"},projectExpenseSubmitHandler),gantt=$("#gantt").gantt({source:gantt_data,itemsPerPage:25,months:JSON.parse(months_json),navigate:"scroll",onRender:function(){$("#gantt .leftPanel .name .fn-label:empty").parents(".name").css("background","initial");$("#gantt .leftPanel .spacer").html('<span class="gantt_project_name"><i class="fa fa-cubes"></i> '+$(".project-name").text()+"</span>");var e=$('input[name="project_percent"]').val();$("#gantt .leftPanel .spacer").append('<div style="padding:10px 20px 10px 20px;"><div class="progress mtop5 progress-bar-mini"><div class="progress-bar progress-bar-success no-percent-text" role="progressbar" aria-valuenow="'+e+'" aria-valuemin="0" aria-valuemax="100" style="width: 0%" data-percent="'+e+'"></div></div></div>'),init_progress_bars()},onItemClick:function(e){init_task_modal(e.task_id)},onAddClick:function(e,t){var i=new DateFormatter,a=new Date(+e),s=i.formatDate(a,app_date_format);new_task(admin_url+"tasks/task?rel_type=project&rel_id="+project_id+"&start_date="+s)}});var n={};$.each($("._hidden_inputs._filters input"),function(){n[$(this).attr("name")]='[name="'+$(this).attr("name")+'"]'}),_table_api=initDataTable(".table-project-expenses",admin_url+"projects/expenses/"+project_id,"undefined","undefined",n,[4,"DESC"]),_table_api&&_table_api.column(0).visible(!1,!1).columns.adjust(),init_rel_tasks_table(project_id,"project"),initDataTable(".table-notes",admin_url+"projects/notes/"+project_id,[4],[4],"undefined",[1,"DESC"]),initDataTable(".table-milestones",admin_url+"projects/milestones/"+project_id,[2],[2]);var o={};$.each($("._hidden_inputs._filters.timesheets_filters input"),function(){o[$(this).attr("name")]='[name="'+$(this).attr("name")+'"]'}),initDataTable(".table-timesheets",admin_url+"projects/timesheets/"+project_id,[8],[8],o,[3,"DESC"]),initDataTable(".table-project-discussions",admin_url+"projects/discussions/"+project_id,[4],[4],"undefined",[1,"DESC"]),_validate_form($("#milestone_form"),{name:"required",due_date:"required"}),_validate_form($("#copy_form"),{start_date:"required"}),_validate_form($("#discussion_form"),{subject:"required"},manage_discussion);var r={},d=$("#timesheet_form").find("select");$.each(d,function(){var e=$(this).attr("name");r[e]="required"}),r.start_time="required",r.end_time="required",_validate_form($("#timesheet_form"),r,manage_timesheets),$("#discussion").on("hidden.bs.modal",function(e){$('#discussion input[name="subject"]').val(""),$('#discussion textarea[name="description"]').val(""),$('#discussion input[name="show_to_customer"]').prop("checked",!0),$("#discussion .add-title").removeClass("hide"),$("#discussion .edit-title").removeClass("hide")}),$("#milestone").on("hidden.bs.modal",function(e){$("#additional_milestone").html(""),$('#milestone input[name="due_date"]').val(""),$('#milestone input[name="name"]').val(""),$('#milestone input[name="milestone_order"]').val($(".table-milestones tbody tr").length+1),$('#milestone textarea[name="description"]').val(""),$('#milestone input[name="description_visible_to_customer"]').prop("checked",!1),$("#milestone .add-title").removeClass("hide"),$("#milestone .edit-title").removeClass("hide")}),$("#timesheet").on("hidden.bs.modal",function(e){$('#timesheet select[name="timesheet_staff_id"]').removeAttr("data-staff_id"),$('#timesheet select[name="timesheet_staff_id"]').empty(),$('#timesheet select[name="timesheet_staff_id"]').selectpicker("refresh"),$('#timesheet select[name="timesheet_task_id"]').selectpicker("val",""),$('#timesheet textarea[name="note"]').val(""),$("#timesheet #tags").tagit("removeAll"),$('input[name="timer_id"]').val("")}),$('#timesheet select[name="timesheet_task_id"]').on("change",function(){var e=$('#timesheet select[name="timesheet_staff_id"]'),t=$(this).val();if(""==t)return e.html(""),void e.selectpicker("refresh");var i;e.attr("data-staff_id")&&(i=e.attr("data-staff_id")),$.get(admin_url+"projects/timesheet_task_assignees/"+t+"/"+project_id+"/"+i,function(t){e.html(t),e.selectpicker("refresh")})}),$('input[name="tasks"].copy').on("change",function(){if($(this).prop("checked")){var e=$('input[name="task_include_assignees"]').prop("checked"),t=$('input[name="task_include_followers"]').prop("checked");(e||t)&&$('input[name="members"].copy').prop("checked",!0),$(".copy-project-tasks-status-wrapper").removeClass("hide")}else $(".copy-project-tasks-status-wrapper").addClass("hide")}),$('input[name="task_include_assignees"],input[name="task_include_followers"]').on("change",function(){1==$(this).prop("checked")&&$('input[name="members"].copy').prop("checked",!0)}),$("body").on("change","#project_invoice_select_all_tasks,#project_invoice_select_all_expenses",function(){var e,t=$(this).prop("checked");e=$(this).hasClass("invoice_select_all_expenses")?'input[name="expenses[]"]':'input[name="tasks[]"]',1==t?$(e).prop("checked",!0):$(e).prop("checked",!1)}),$("body").on("change",'input[name="invoice_data_type"]',function(){"timesheets_individualy"==$(this).val()?$("#timesheets_bill_include_notes").removeClass("hide"):$("#timesheets_bill_include_notes").addClass("hide")}),$('input[name="members"].copy').on("change",function(){var e=$(this).prop("checked"),t=$('input[name="tasks"].copy').prop("checked");e?t&&($('input[name="task_include_assignees"]').prop("checked",!0),$('input[name="task_include_followers"]').prop("checked",!0)):t&&($('input[name="task_include_assignees"]').prop("checked",!1),$('input[name="task_include_followers"]').prop("checked",!1))})});